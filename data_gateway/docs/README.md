# æ•°æ®ç½‘å…³æœåŠ¡ - æ¶æ„è®¾è®¡ä¸åŠŸèƒ½è¯´æ˜

## ç›®å½•

- [æœåŠ¡æ¦‚è¿°](#æœåŠ¡æ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [æ•°æ®æºè¯´æ˜](#æ•°æ®æºè¯´æ˜)
- [åŠŸèƒ½è¯´æ˜](#åŠŸèƒ½è¯´æ˜)
- [API æ¥å£](#api-æ¥å£)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æœåŠ¡æ¦‚è¿°

æ•°æ®ç½‘å…³æœåŠ¡æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®æ¥å£æœåŠ¡ï¼Œä¸ºå¤–éƒ¨å¹³å°æä¾›ç»Ÿä¸€çš„é‡‘èæ•°æ®è·å–æ¥å£ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **å¤šå¸‚åœºæ”¯æŒ**: Aè‚¡ã€æ¸¯è‚¡ã€ç¾è‚¡ã€æœŸè´§ã€ç»æµæŒ‡æ ‡
- **å¤šæ•°æ®æºè‡ªåŠ¨åˆ‡æ¢**: AKShare (å®æ—¶) + BaoStock (å†å²) + Miana (å•†ä¸šæ•°æ®)
- **å¤šç§æ¥å£**: HTTP API + Redis æ¶ˆæ¯é˜Ÿåˆ—
- **Docker éƒ¨ç½²**: å¼€ç®±å³ç”¨
- **ç»Ÿä¸€æ•°æ®æ ¼å¼**: æ ‡å‡†åŒ–è¿”å›
- **å®šæ—¶åŒæ­¥**: æ”¯æŒæ‰¹é‡å†å²æ•°æ®åŒæ­¥
- **å¥åº·ç›‘æ§**: æ•°æ®æºå¥åº·çŠ¶æ€å®æ—¶ç›‘æ§

### æœåŠ¡ç«¯å£

| æœåŠ¡ | ç«¯å£ |
|------|------|
| æ•°æ®ç½‘å…³ API | 8001 |
| PostgreSQL | 5432 |
| Redis | 6379 |

---

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯åº”ç”¨                              â”‚
â”‚                     (SAPAS / ç¬¬ä¸‰æ–¹å¹³å°)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ HTTP API
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®ç½‘å…³æœåŠ¡ (FastAPI)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           API è·¯ç”±å±‚ (routes.py)                        â”‚  â”‚
â”‚  â”‚  - /api/v1/quote      å®æ—¶è¡Œæƒ…                          â”‚  â”‚
â”‚  â”‚  - /api/v1/kline      Kçº¿æ•°æ®                           â”‚  â”‚
â”‚  â”‚  - /api/v1/fundamentals åŸºæœ¬é¢æ•°æ®                      â”‚  â”‚
â”‚  â”‚  - /api/v1/money-flow èµ„é‡‘æµå‘ (Miana)                  â”‚  â”‚
â”‚  â”‚  - /api/v1/sectors/*   æ¿å—æ•°æ® (Miana)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         ç½‘å…³ç®¡ç†å™¨ (gateway/manager.py)                  â”‚  â”‚
â”‚  â”‚         - è·¯ç”±åˆ°å¯¹åº”å¸‚åœºç½‘å…³                            â”‚  â”‚
â”‚  â”‚         - æ•°æ®æºè‡ªåŠ¨åˆ‡æ¢                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      â”‚                                   â”‚  â”‚
â”‚  â–¼                      â–¼                                   â–¼  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚ â”‚ Aè‚¡ç½‘å…³ â”‚      â”‚ æ¸¯è‚¡ç½‘å…³ â”‚ ...  â”‚ ç»æµæŒ‡æ ‡ç½‘å…³ â”‚             â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚                â”‚
       â–¼               â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®æºå±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ AKShare  â”‚  â”‚ BaoStock â”‚  â”‚  Mianaå¹³å°  â”‚                  â”‚
â”‚  â”‚ (å®æ—¶)   â”‚  â”‚ (å†å²)   â”‚  â”‚  (å•†ä¸šæ•°æ®) â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PostgreSQL æ•°æ®åº“                           â”‚
â”‚  - request_logs    API è¯·æ±‚æ—¥å¿—                                â”‚
â”‚  - stock_daily_k   æ¯æ—¥Kçº¿æ•°æ®                                 â”‚
â”‚  - sync_logs       æ•°æ®åŒæ­¥æ—¥å¿—                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
data_gateway/
â”œâ”€â”€ src/                         # æºä»£ç 
â”‚   â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database.py             # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ gateway/               # æ•°æ®ç½‘å…³
â”‚   â”‚   â”œâ”€â”€ base.py           # åŸºç±» (DataSource, MarketGateway)
â”‚   â”‚   â”œâ”€â”€ manager.py        # ç½‘å…³ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ markets/          # å¸‚åœºå®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ cn_a.py       # Aè‚¡å¸‚åœº
â”‚   â”‚   â”‚   â”œâ”€â”€ hk.py         # æ¸¯è‚¡å¸‚åœº
â”‚   â”‚   â”‚   â”œâ”€â”€ us.py         # ç¾è‚¡å¸‚åœº
â”‚   â”‚   â”‚   â”œâ”€â”€ futures.py    # æœŸè´§å¸‚åœº
â”‚   â”‚   â”‚   â””â”€â”€ economic.py   # ç»æµæŒ‡æ ‡
â”‚   â”‚   â””â”€â”€ sources/          # æ•°æ®æºå®ç°
â”‚   â”‚       â””â”€â”€ miana_source.py  # Mianaæ•°æ®æº
â”‚   â”œâ”€â”€ api/                  # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ routes.py         # å…¬å…±API
â”‚   â”‚   â””â”€â”€ admin_routes.py   # ç®¡ç†API
â”‚   â”œâ”€â”€ services/             # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ sync_service.py   # æ•°æ®åŒæ­¥æœåŠ¡
â”‚   â”‚   â””â”€â”€ scheduler_service.py  # å®šæ—¶è°ƒåº¦
â”‚   â”œâ”€â”€ models/               # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ kline.py
â”‚   â”‚   â”œâ”€â”€ stock_daily_k.py
â”‚   â”‚   â””â”€â”€ sync_log.py
â”‚   â””â”€â”€ utils/               # å·¥å…·
â”‚       â””â”€â”€ logger.py
â”œâ”€â”€ scripts/                 # è„šæœ¬
â”‚   â”œâ”€â”€ init_db.py          # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â””â”€â”€ sync_all.py         # æ•°æ®åŒæ­¥è„šæœ¬
â”œâ”€â”€ logs/                   # æ—¥å¿—ç›®å½•
â”œâ”€â”€ docs/                   # æ–‡æ¡£ç›®å½•
â”œâ”€â”€ Dockerfile              # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ requirements.txt        # Python ä¾èµ–
â””â”€â”€ README.md              # æœ¬æ–‡ä»¶
```

---

## æ•°æ®æºè¯´æ˜

### æ•°æ®æºå¯¹æ¯”

| æ•°æ®æº | ç”¨é€” | å®æ—¶æ•°æ® | å†å²æ•°æ® | ç‰¹è‰²åŠŸèƒ½ |
|--------|------|---------|---------|---------|
| **AKShare** | å¼€æºå…è´¹æ•°æ® | âœ… | âœ… | è¦†ç›–é¢å¹¿ï¼Œæ›´æ–°åŠæ—¶ |
| **BaoStock** | è¯åˆ¸æ•°æ® | âš ï¸ å»¶è¿Ÿ | âœ… | è´¢åŠ¡æ•°æ®å…¨é¢ |
| **Miana** | å•†ä¸šæ•°æ®å¹³å° | âœ… | âœ… | èµ„é‡‘æµå‘ã€æ¿å—æ•°æ®ã€äº”æ¡£ç›˜å£ |

### Miana æ•°æ®å¹³å°

Miana æ˜¯å•†ä¸šæ•°æ®å¹³å°ï¼Œæä¾›é«˜è´¨é‡çš„ä¸“ä¸šæ•°æ®ï¼š

**å®˜ç½‘**: https://miana.com.cn

**æ•°æ®ç‰¹ç‚¹**:
- å…¨çƒè¦†ç›–ï¼š30+ å›½å®¶ï¼Œ40+ äº¤æ˜“æ‰€
- å®æ—¶æ•°æ®ï¼šåŒ…å«äº”æ¡£ç›˜å£æ•°æ®
- èµ„é‡‘æµå‘ï¼šå½“æ—¥èµ„é‡‘æµå‘ã€å¤§å•åˆ†ç±»
- å†å²æ•°æ®ï¼š30+ å¹´
- è‚¡ç¥¨æ•°é‡ï¼š100,000+

**ç‰¹è‰²æ•°æ®**:
1. **å®æ—¶äº”æ¡£ç›˜å£**: ä¹°ä¸€~ä¹°äº”ã€å–ä¸€~å–äº”çš„ä»·æ ¼å’Œé‡
2. **èµ„é‡‘æµå‘**: å¤§å•ã€ä¸­å•ã€å°å•å‡€æµå…¥åˆ†ç±»
3. **æ¿å—æ•°æ®**: è¡Œä¸šæ¿å—ã€æ¦‚å¿µæ¿å—å®æ—¶è¡Œæƒ…
4. **å¸‚åœºæ•°æ®**: å¸‚å€¼ã€è‚¡æœ¬ã€æ¶¨è·Œåœä»·æ ¼ç­‰

**é…ç½®æ–¹å¼**:
åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½® `MIANA_TOKEN` å³å¯å¯ç”¨ã€‚

---

## åŠŸèƒ½è¯´æ˜

### æ”¯æŒçš„å¸‚åœº

| å¸‚åœº | ä»£ç  | å®æ—¶è¡Œæƒ… | Kçº¿ | åŸºæœ¬é¢ | èµ„é‡‘æµå‘ | æ¿å—æ•°æ® |
|------|------|---------|-----|--------|---------|---------|
| Aè‚¡ | `cn_a` | âœ… AKShare/Miana | âœ… | âœ… | âœ… Miana | âœ… Miana |
| æ¸¯è‚¡ | `hk` | âœ… AKShare | âœ… | âŒ | âŒ | âŒ |
| ç¾è‚¡ | `us` | âœ… AKShare | âœ… | âŒ | âŒ | âŒ |
| æœŸè´§ | `futures` | âœ… AKShare | âœ… | âŒ | âŒ | âŒ |
| ç»æµæŒ‡æ ‡ | `economic` | âŒ | âœ… | âŒ | âŒ | âŒ |

### æ•°æ®åŒæ­¥åŠŸèƒ½

**æ”¯æŒçš„æ•°æ®åŒæ­¥**:
- è‚¡ç¥¨åˆ—è¡¨åŒæ­¥
- æ¯æ—¥Kçº¿æ•°æ®åŒæ­¥
- å¢é‡æ›´æ–°ï¼ˆåªåŒæ­¥æœ€æ–°äº¤æ˜“æ—¥æ•°æ®ï¼‰

**è°ƒåº¦æœåŠ¡**:
- è‡ªåŠ¨æ£€æµ‹äº¤æ˜“æ—¥
- å®šæ—¶æ‰§è¡Œæ•°æ®æ›´æ–°
- åŒæ­¥ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª

---

## API æ¥å£

### å…¬å…± API

#### 1. è·å–å®æ—¶è¡Œæƒ…

```bash
POST /api/v1/quote
Content-Type: application/json

{
  "market": "cn_a",
  "symbols": ["000001", "600000"]
}
```

**å“åº”**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "000001": {
      "symbol": "000001",
      "name": "å¹³å®‰é“¶è¡Œ",
      "price": 11.23,
      "open": 11.20,
      "high": 11.30,
      "low": 11.15,
      "volume": 12345678,
      "amount": 138765432.1,
      "change": 0.05,
      "change_pct": 0.45,
      "bid": 11.22,
      "ask": 11.24,
      "timestamp": "2026-01-26 10:30:00",
      "market": "cn_a"
    }
  }
}
```

#### 2. è·å–Kçº¿æ•°æ®

```bash
GET /api/v1/kline?market=cn_a&symbol=000001&period=daily&start_date=2025-01-01&end_date=2026-01-26
```

**å‚æ•°è¯´æ˜**:
- `market`: å¸‚åœºä»£ç  (cn_a, hk, us, futures, economic)
- `symbol`: è‚¡ç¥¨ä»£ç 
- `period`: å‘¨æœŸ (1m, 5m, 15m, 30m, 60m, daily, weekly, monthly)
- `start_date`: å¼€å§‹æ—¥æœŸ YYYY-MM-DD
- `end_date`: ç»“æŸæ—¥æœŸ YYYY-MM-DD

**å“åº”**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "symbol": "000001",
      "datetime": "2026-01-26",
      "open": 11.20,
      "close": 11.23,
      "high": 11.30,
      "low": 11.15,
      "volume": 12345678,
      "amount": 138765432.1,
      "period": "daily",
      "market": "cn_a"
    }
  ]
}
```

#### 3. è·å–åŸºæœ¬é¢æ•°æ®

```bash
GET /api/v1/fundamentals?market=cn_a&symbol=000001
```

**å“åº”**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "symbol": "000001",
    "name": "å¹³å®‰é“¶è¡Œ",
    "market": "cn_a",
    "revenue": 158763000000,
    "net_profit": 45632000000,
    "eps": 2.35,
    "bvps": 18.45,
    "pe": 4.78,
    "pb": 0.61,
    "market_cap": 217654321000
  }
}
```

#### 4. å¥åº·æ£€æŸ¥

```bash
GET /health
```

**å“åº”**:
```json
{
  "service": "data-gateway",
  "status": "healthy",
  "timestamp": "2026-01-26T10:30:00",
  "markets": {
    "cn_a": true,
    "hk": true,
    "us": true,
    "futures": true,
    "economic": true
  }
}
```

### ç¼…Aå¹³å°ç‰¹è‰² API

#### 5. è·å–èµ„é‡‘æµå‘

```bash
GET /api/v1/money-flow/600519?date=2026-01-26
```

**å‚æ•°è¯´æ˜**:
- `symbol`: è‚¡ç¥¨ä»£ç 
- `date`: æ—¥æœŸ YYYY-MM-DDï¼Œé»˜è®¤å½“å¤©

**å“åº”**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "symbol": "600519",
    "date": "2026-01-26",
    "large_inflow": 1234567890,
    "large_outflow": 987654321,
    "medium_inflow": 234567890,
    "medium_outflow": 123456789,
    "small_inflow": 34567890,
    "small_outflow": 12345678,
    "net_inflow": 123456789
  }
}
```

#### 6. è·å–è¡Œä¸šæ¿å—

```bash
GET /api/v1/sectors/industry
```

**å“åº”**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "sector_name": "é“¶è¡Œ",
      "change_pct": 1.23,
      "amount": 1234567890,
      "stock_count": 42
    }
  ]
}
```

#### 7. è·å–æ¦‚å¿µæ¿å—

```bash
GET /api/v1/sectors/concept
```

**å“åº”**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "sector_name": "äººå·¥æ™ºèƒ½",
      "change_pct": 2.45,
      "amount": 987654321,
      "stock_count": 56
    }
  ]
}
```

### WebSocket API

#### 1. å®æ—¶è¡Œæƒ…æ¨é€ (æ¨è)

**è¿æ¥æ–¹å¼**:
```bash
ws://localhost:8001/ws/quote
```

**è®¢é˜…æ¶ˆæ¯æ ¼å¼**:
```json
{
  "action": "subscribe",
  "symbols": ["000001", "600000"],
  "market": "cn_a"
}
```

**æ¨é€æ¶ˆæ¯æ ¼å¼**:
```json
{
  "type": "quote",
  "symbol": "000001",
  "name": "å¹³å®‰é“¶è¡Œ",
  "price": 11.23,
  "open": 11.20,
  "high": 11.30,
  "low": 11.15,
  "volume": 12345678,
  "amount": 138765432.1,
  "change": 0.05,
  "change_pct": 0.45,
  "timestamp": "2026-01-26 10:30:00"
}
```

**å®¢æˆ·ç«¯ç¤ºä¾‹**:
```javascript
const ws = new WebSocket("ws://localhost:8001/ws/quote");

ws.onopen = function() {
  // è®¢é˜…è‚¡ç¥¨
  ws.send(JSON.stringify({
    action: "subscribe",
    symbols: ["000001", "600000"],
    market: "cn_a"
  }));
};

ws.onmessage = function(event) {
  const data = JSON.parse(event.data);
  console.log("æ”¶åˆ°è¡Œæƒ…:", data);
};

// å‘é€å¿ƒè·³
setInterval(() => {
  ws.send(JSON.stringify({ action: "ping" }));
}, 30000);
```

#### 2. æŒ‰å¸‚åœºè®¢é˜…

**è¿æ¥æ–¹å¼**:
```bash
ws://localhost:8001/ws/market/cn_a
```

**å‚æ•°**:
- `market`: å¸‚åœºä»£ç  (cn_a, hk, us, futures, economic)

#### 3. æŒ‰è‚¡ç¥¨åˆ—è¡¨è®¢é˜…

**è¿æ¥æ–¹å¼**:
```bash
ws://localhost:8001/ws/symbols?symbols=000001,600000
```

**å‚æ•°**:
- `symbols`: è‚¡ç¥¨ä»£ç ï¼Œé€—å·åˆ†éš”

#### 4. WebSocket ç»Ÿè®¡

**æ¥å£**:
```bash
GET /ws/stats
```

**å“åº”**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total_connections": 10,
    "total_symbol_subscriptions": 25,
    "total_market_subscriptions": 3,
    "symbol_count": 15,
    "market_count": 3
  }
}
```

#### 5. WebSocket æµ‹è¯•é¡µé¢

è®¿é—®ä»¥ä¸‹åœ°å€æµ‹è¯• WebSocket è¿æ¥ï¼š
```
http://localhost:8001/ws/test
```

æµ‹è¯•é¡µé¢åŠŸèƒ½ï¼š
- è¿æ¥/æ–­å¼€ WebSocket
- è®¢é˜…æŒ‡å®šè‚¡ç¥¨
- å‘é€å¿ƒè·³
- æŸ¥çœ‹å®æ—¶æ¶ˆæ¯

### ç®¡ç† API

#### åˆ›å»ºåŒæ­¥ä»»åŠ¡

```bash
POST /api/v1/admin/sync/create
```

#### æŸ¥è¯¢åŒæ­¥çŠ¶æ€

```bash
GET /api/v1/admin/sync/status/{task_id}
```

#### è·å–æ´»è·ƒåŒæ­¥ä»»åŠ¡

```bash
GET /api/v1/admin/sync/active
```

#### å¿«é€ŸåŒæ­¥

```bash
POST /api/v1/admin/sync/quick
```

#### è·å–è‚¡ç¥¨åˆ—è¡¨

```bash
GET /api/v1/admin/stocks/list
```

#### è·å–ç»Ÿè®¡ä¿¡æ¯

```bash
GET /api/v1/admin/stats
```

---

## æ•°æ®åº“è®¾è®¡

### æ•°æ®åº“æ¦‚è¿°

æ•°æ®ç½‘å…³æœåŠ¡ä½¿ç”¨ç‹¬ç«‹çš„ `data_gateway` æ•°æ®åº“ï¼Œä¸ SAPAS ä¸»ç³»ç»Ÿçš„ `sapas_db` å®Œå…¨åˆ†ç¦»ã€‚

### æ•°æ®åº“å¯¹æ¯”

| æ•°æ®åº“ | ç”¨é€” | ä¸»è¦è¡¨ |
|--------|------|--------|
| `sapas_db` | SAPAS ä¸»ç³»ç»Ÿ | stocks, users, backtests, alerts |
| `data_gateway` | æ•°æ®ç½‘å…³æœåŠ¡ | stock_daily_k, sync_logs, request_logs |

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. stock_daily_k - æ¯æ—¥Kçº¿æ•°æ®

```sql
CREATE TABLE stock_daily_k (
    id SERIAL PRIMARY KEY,
    ts_code VARCHAR(20) NOT NULL,      -- è‚¡ç¥¨ä»£ç 
    trade_date DATE NOT NULL,           -- äº¤æ˜“æ—¥æœŸ
    open DECIMAL(10, 2),                -- å¼€ç›˜ä»·
    high DECIMAL(10, 2),                -- æœ€é«˜ä»·
    low DECIMAL(10, 2),                 -- æœ€ä½ä»·
    close DECIMAL(10, 2),               -- æ”¶ç›˜ä»·
    pre_close DECIMAL(10, 2),           -- å‰æ”¶ç›˜ä»·
    vol DECIMAL(15, 2),                 -- æˆäº¤é‡(æ‰‹)
    amount DECIMAL(15, 2),              -- æˆäº¤é¢(åƒå…ƒ)
    adj_factor DECIMAL(10, 6),          -- å¤æƒå› å­
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(ts_code, trade_date)
);
```

**ç´¢å¼•**:
```sql
CREATE INDEX idx_stock_daily_k_ts_code ON stock_daily_k(ts_code);
CREATE INDEX idx_stock_daily_k_trade_date ON stock_daily_k(trade_date);
```

#### 2. sync_logs - åŒæ­¥æ—¥å¿—

```sql
CREATE TABLE sync_logs (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(50) NOT NULL,     -- åŒæ­¥ç±»å‹: stock_list, daily_k
    status VARCHAR(20) NOT NULL,         -- çŠ¶æ€: running, completed, failed
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP,
    records_processed INTEGER DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3. request_logs - API è¯·æ±‚æ—¥å¿—

```sql
CREATE TABLE request_logs (
    id SERIAL PRIMARY KEY,
    endpoint VARCHAR(100) NOT NULL,
    method VARCHAR(10) NOT NULL,
    request_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    response_time INTEGER,               -- å“åº”æ—¶é—´(æ¯«ç§’)
    status_code INTEGER,
    ip_address VARCHAR(50)
);
```

### ç»´æŠ¤å‘½ä»¤

```sql
-- æŸ¥çœ‹ä»Šæ—¥Kçº¿æ•°æ®
SELECT ts_code, trade_date, close, volume
FROM stock_daily_k
WHERE trade_date = CURRENT_DATE
ORDER BY volume DESC
LIMIT 10;

-- æŸ¥çœ‹åŒæ­¥è®°å½•
SELECT * FROM sync_logs
ORDER BY start_time DESC
LIMIT 10;

-- æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™30å¤©ï¼‰
DELETE FROM request_logs
WHERE request_time < CURRENT_DATE - INTERVAL '30 days';
```

---

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€: Docker éƒ¨ç½² (æ¨è)

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd data_gateway

# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f data-gateway

# 4. è®¿é—®æ–‡æ¡£
open http://localhost:8001/docs
```

### æ–¹å¼äºŒ: æœ¬åœ°è¿è¡Œ

#### Linux/Mac

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶

# 3. åˆå§‹åŒ–æ•°æ®åº“
python scripts/init_db.py

# 4. å¯åŠ¨æœåŠ¡
python run_server.py
```

#### Windows

```cmd
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. é…ç½®ç¯å¢ƒå˜é‡
copy .env.example .env
REM ç¼–è¾‘ .env æ–‡ä»¶

# 3. åˆå§‹åŒ–æ•°æ®åº“
python scripts\init_db.py

# 4. å¯åŠ¨æœåŠ¡
python run_server.py
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶å¹¶é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

```bash
# ============== æœåŠ¡é…ç½® ==============
DG_HOST=0.0.0.0
DG_PORT=8001
DG_VERSION=1.0.0
DG_DEBUG=false
DG_LOG_LEVEL=INFO

# ============== æ•°æ®åº“é…ç½® ==============
DG_DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/data_gateway

# ============== Redis é…ç½® ==============
DG_REDIS_URL=redis://localhost:6379/0

# ============== Miana æ•°æ®å¹³å°é…ç½® ==============
MIANA_TOKEN=your_miana_token_here

# ============== æ—¥å¿—é…ç½® ==============
DG_LOG_FILE=logs/data_gateway.log
DG_LOG_ROTATION=10 MB
DG_LOG_RETENTION=30 days
```

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°å¸‚åœº

1. åœ¨ `src/gateway/markets/` åˆ›å»ºæ–°æ–‡ä»¶
2. ç»§æ‰¿ `MarketGateway` ç±»
3. å®ç°æ•°æ®æº `DataSource`
4. åœ¨ `manager.py` æ³¨å†Œæ–°å¸‚åœº

ç¤ºä¾‹ï¼š
```python
from ..base import MarketGateway

class NewMarketGateway(MarketGateway):
    def __init__(self):
        super().__init__("new_market")
        self.sources = [...]
```

### æ·»åŠ æ–°æ•°æ®æº

1. ç»§æ‰¿ `DataSource` åŸºç±»
2. å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š
   - `get_quote()`
   - `get_kline()`
   - `get_fundamentals()`

ç¤ºä¾‹ï¼š
```python
from ..base import DataSource

class NewDataSource(DataSource):
    def __init__(self):
        super().__init__("NewSource")

    async def get_quote(self, symbols, market):
        # å®ç°è·å–å®æ—¶è¡Œæƒ…
        pass

    async def get_kline(self, symbol, period, start_date, end_date, market):
        # å®ç°è·å–Kçº¿æ•°æ®
        pass

    async def get_fundamentals(self, symbol, market):
        # å®ç°è·å–åŸºæœ¬é¢æ•°æ®
        pass
```

---

## æ•…éšœæ’æŸ¥

### æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep 8001

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/data_gateway.log
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ PostgreSQL çŠ¶æ€
docker-compose ps postgres

# æµ‹è¯•è¿æ¥
psql -h localhost -U postgres -d data_gateway
```

### æ•°æ®è·å–å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®æºå¥åº·
curl http://localhost:8001/health

# æŸ¥çœ‹åŒæ­¥æ—¥å¿—
curl http://localhost:8001/api/v1/admin/sync/active
```

### Docker æ„å»ºå¤±è´¥

Windows ä¸‹å¯èƒ½å‡ºç°æ–‡ä»¶æƒé™é—®é¢˜ï¼Œè¯·ç¡®ä¿ï¼š
1. åˆ é™¤ `__pycache__` ç›®å½•
2. åˆ é™¤ `venv` è™šæ‹Ÿç¯å¢ƒç›®å½•
3. ä¸åŒ…å«ç¬¦å·é“¾æ¥æ–‡ä»¶

---

## åŠŸèƒ½å·®è·åˆ†æ

### å½“å‰æ”¯æŒçš„åŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | æ”¯æŒæƒ…å†µ | æ•°æ®æº |
|---------|---------|--------|
| å®æ—¶è¡Œæƒ… | âœ… å®Œæ•´æ”¯æŒ | AKShare + Miana |
| Kçº¿æ•°æ® | âœ… å®Œæ•´æ”¯æŒ | AKShare + BaoStock + Miana |
| åŸºæœ¬é¢æ•°æ® | âœ… å®Œæ•´æ”¯æŒ | BaoStock |
| èµ„é‡‘æµå‘ | âœ… å®Œæ•´æ”¯æŒ | Miana |
| æ¿å—æ•°æ® | âœ… å®Œæ•´æ”¯æŒ | Miana |
| äº”æ¡£ç›˜å£ | âœ… å®Œæ•´æ”¯æŒ | Miana |
| æ•°æ®åŒæ­¥ | âœ… å®Œæ•´æ”¯æŒ | BaoStock |
| å¥åº·ç›‘æ§ | âœ… å®Œæ•´æ”¯æŒ | å†…ç½® |

### å¾…å¼€å‘åŠŸèƒ½

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|-------|------|
| åˆ†é’ŸKçº¿ | ğŸ”´ é«˜ | æ‰©å±•ç°æœ‰Kçº¿æ¥å£æ”¯æŒåˆ†é’Ÿçº§ |
| é¾™è™æ¦œ | ğŸŸ¡ ä¸­ | éœ€è¦æ·»åŠ AKShareæ¥å£ |
| ETFæ•°æ® | ğŸŸ¢ ä½ | å»ºè®®ä½¿ç”¨AKShare |
| å¤§å•äº¤æ˜“ | ğŸŸ¢ ä½ | è¯¦ç»†çš„é€ç¬”å¤§å•æ•°æ® |

---

## è®¸å¯è¯

MIT License
